

## Imports
```{r}
library(kableExtra)
library(ggplot2)
library(ggpubr)
library(patchwork)
library(vegan)
```


## Sources

The file handles are set in config.R as they're used by both this script and data_cleaning.

```{r}
source("/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/from_Leo/Leonardos_analysis/bin/core_functions.R")
source("/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/from_Leo/Leonardos_analysis/bin/config.R")
```


## Metadata basics

First do the plots with kruskall wallis comparison between groups to see if there's an overall difference, then do the pairwise tests because KW says there is a difference.


```{r}
metadata <- read_metadata(metadata_handle)

number_per_country <- metadata %>% group_by(Country) %>% summarise(count = n())

number_per_country %>% kbl() %>% kable_styling()

print(sum(number_per_country$count))

baseline_chars <- get_baseline_characteristics(metadata)
baseline_chars %>% kbl(digits = c(NA, NA, 0, 0, 1, 1)) %>% kable_styling()

ggplot(metadata, aes(x = Country, y = Age, fill = Group)) + geom_boxplot() + stat_compare_means(method = 'kruskal.test', label = "p")
comparisons <- list(c("Acute_Typhi", "Carrier"), c("Acute_Typhi", "Control_HealthySerosurvey"), c("Carrier", "Control_HealthySerosurvey"))
# default stat method when doing pairwise tests in wilcoxon.
ggboxplot(metadata, facet.by = "Country", y = "Age", x = "Group", color = "Group") + stat_compare_means(comparisons = comparisons) + rremove("x.text") + rremove("xlab") + rremove("x.ticks") # +rotate_x_text(angle = 45)
```

## pairwise beta

```{r}
run_plot_beta <- function(output_folder, meta, vars_to_plot){
  pcoa.data.handle <- file.path(output_folder, '4_beta', "first_2d_coords.txt")
  pcoa.var.handle <- file.path(output_folder, '4_beta', "pcoa_var.txt")
  pcoa.data <- read_delim(pcoa.data.handle, delim = " ", escape_double = FALSE, trim_ws = TRUE)
  #pcoa.data <- pcoa.data %>% separate(col = Y, sep = '\t', into = c('x', 'y')) %>% rename(ID = X)
  pcoa.var <- read_delim(pcoa.var.handle, delim = " ", escape_double = FALSE, trim_ws = TRUE)
  #pcoa.data <- read_tsv(pcoa.data.handle)
  
  meta_for_beta <- meta %>% select(isolate, Country, Group, Sex, age_bracket, Antibiotics_taken_before_sampling_yes_no_assumptions, group_country, group_antibiotic)
  
  pcoa.data <- left_join(pcoa.data, meta_for_beta, by = c('Sample' = 'isolate'))

  # add some different plots to the below
  # or, change this function to take the variable to colour by
  plots <- plot_beta(pcoa.data, pcoa.var, vars_to_plot)
  return(plots)
}
```

### All three countries

Plots

```{r}
all_three_vars_to_plot <- c('Country', 'Group', 'Sex', 'age_bracket', 'group_country', 'group_antibiotic')
all_three_plots <- run_plot_beta(output_folder_all_three, metadata, all_three_vars_to_plot)

all_three_plots$country_plot
all_three_plots$group_plot
all_three_plots$sex_plot
all_three_plots$age_plot
all_three_plots$group_country_plot
all_three_plots$group_antibiotic_plot

```

PERMANOVA

```{r cache=TRUE}
pn_all3_csgaa_res <- read_delim(file.path(output_folder_all_three, '4_beta', 'all_3.permanova.csgaa.tsv'))
pn_all3_csgaa_res %>% kbl %>% kable_styling()
```


### Just Blantyre

Plots

```{r}
blantyre_vars_to_plot <- c('Group', 'Sex', 'age_bracket', 'group_antibiotic')
blantyre_plots <- run_plot_beta(output_folder_blantyre, metadata, all_three_vars_to_plot)
blantyre_plots$group_plot
blantyre_plots$sex_plot
blantyre_plots$age_plot
blantyre_plots$group_antibiotic_plot
```

PERMANOVA

```{r cache=TRUE}
blantyre_d.bray <- readRDS(file.path(output_folder_blantyre, '4_beta', 'd.bray.RDS'))
blantyre_meta_permanova <- readRDS(file.path(output_folder_blantyre, '4_beta', 'meta_for_permanova.RDS'))
pn_blantyre_sgaa <- adonis(blantyre_d.bray~Sex*Group*age_bracket*Antibiotics_taken_before_sampling_yes_no_assumptions, data = blantyre_meta_permanova, permutations = 1000)

pn_blantyre_sgaa_res <- pn_blantyre_sgaa$aov.tab %>% mutate(significant = ifelse(`Pr(>F)` < 0.01, 'significant', 'not_significant')) %>% arrange(desc(significant), desc(R2)) %>% select(!c(Df, SumsOfSqs, MeanSqs, F.Model))

pn_blantyre_sgaa_res %>% kbl %>% kable_styling()

```

### Just Dhaka

Plots

```{r}
dhaka_vars_to_plot <- c('Group', 'Sex', 'age_bracket', 'group_antibiotic')
dhaka_plots <- run_plot_beta(output_folder_dhaka, metadata, all_three_vars_to_plot)
dhaka_plots$group_plot
dhaka_plots$sex_plot
dhaka_plots$age_plot
dhaka_plots$group_antibiotic_plot
```

PERMANOVA

```{r cache=TRUE}
dhaka_d.bray <- readRDS(file.path(output_folder_dhaka, '4_beta', 'd.bray.RDS'))
dhaka_meta_permanova <- readRDS(file.path(output_folder_dhaka, '4_beta', 'meta_for_permanova.RDS'))
pn_dhaka_sgaa <- adonis(dhaka_d.bray~Sex*Group*age_bracket*Antibiotics_taken_before_sampling_yes_no_assumptions, data = dhaka_meta_permanova, permutations = 1000)

pn_dhaka_sgaa_res <- pn_dhaka_sgaa$aov.tab %>% mutate(significant = ifelse(`Pr(>F)` < 0.01, 'significant', 'not_significant')) %>% arrange(desc(significant), desc(R2)) %>% select(!c(Df, SumsOfSqs, MeanSqs, F.Model))

pn_dhaka_sgaa_res %>% kbl %>% kable_styling()
```


### Just Kathmandu

Plots

```{r}
kathmandu_vars_to_plot <- c('Group', 'Sex', 'age_bracket', 'group_antibiotic')
kathmandu_plots <- run_plot_beta(output_folder_kathmandu, metadata, all_three_vars_to_plot)
kathmandu_plots$group_plot
kathmandu_plots$sex_plot
kathmandu_plots$age_plot
kathmandu_plots$group_antibiotic_plot
```

PERMANOVA

```{r cache=TRUE}
kathmandu_d.bray <- readRDS(file.path(output_folder_kathmandu, '4_beta', 'd.bray.RDS'))
kathmandu_meta_permanova <- readRDS(file.path(output_folder_kathmandu, '4_beta', 'meta_for_permanova.RDS'))
pn_kathmandu_sgaa <- adonis(kathmandu_d.bray~Sex*Group*age_bracket*Antibiotics_taken_before_sampling_yes_no_assumptions, data = kathmandu_meta_permanova, permutations = 1000)

pn_kathmandu_sgaa_res <- pn_kathmandu_sgaa$aov.tab %>% mutate(significant = ifelse(`Pr(>F)` < 0.01, 'significant', 'not_significant')) %>% arrange(desc(significant), desc(R2)) %>% select(!c(Df, SumsOfSqs, MeanSqs, F.Model))

pn_kathmandu_sgaa_res %>% kbl %>% kable_styling()

```

### Blantyre and Dhaka


Plots

```{r}
blantyre_dhaka_vars_to_plot <- c('Group', 'Sex', 'age_bracket', 'group_antibiotic')
blantyre_dhaka_plots <- run_plot_beta(output_folder_blantyre_dhaka, metadata, all_three_vars_to_plot)
blantyre_dhaka_plots$group_plot
blantyre_dhaka_plots$sex_plot
blantyre_dhaka_plots$age_plot
blantyre_dhaka_plots$group_antibiotic_plot
```

PERMANOVA

```{r cache=TRUE}
blantyre_dhaka_d.bray <- readRDS(file.path(output_folder_blantyre_dhaka, '4_beta', 'd.bray.RDS'))
blantyre_dhaka_meta_permanova <- readRDS(file.path(output_folder_blantyre_dhaka, '4_beta', 'meta_for_permanova.RDS'))
pn_blantyre_dhaka_csgaa <- adonis(blantyre_dhaka_d.bray~Country*Sex*Group*age_bracket*Antibiotics_taken_before_sampling_yes_no_assumptions, data = blantyre_dhaka_meta_permanova, permutations = 1000)

pn_blantyre_dhaka_csgaa_res <- pn_blantyre_dhaka_csgaa$aov.tab %>% mutate(significant = ifelse(`Pr(>F)` < 0.01, 'significant', 'not_significant')) %>% arrange(desc(significant), desc(R2)) %>% select(!c(Df, SumsOfSqs, MeanSqs, F.Model))

pn_blantyre_dhaka_csgaa_res %>% kbl %>% kable_styling()

```


## Alpha diversity

```{r}
run_calc_alpha <- function(input_braken_folder, out_folder, level, country){
  print('running calc alpha')
  samples_regexp = "\\d+_\\d+_\\d+" #for patch and strata
  data_table <- filter_data(input_braken_folder, level, samples_regexp, out_folder)
  print('done reading data')
  meta <- meta %>% filter(Country == 'Malawi' | Country == 'Bangladesh')
  View(data_table)
  calculate_alpha(data_table, "kraken_assigned_reads", meta, quote("Group"), out_folder, "Phenotype", level, TRUE)  
}


run_calc_alpha("/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/from_Leo/Leonardos_analysis/1_taxonomic_profiling/bracken_output/species/", "/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/from_Leo/Leonardos_analysis/phil_blantyre_dhaka/", "species", "Malawi")
```


