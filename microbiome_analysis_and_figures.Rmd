

## Imports
```{r}
library(kableExtra)
library(ggplot2)
library(ggpubr)
library(patchwork)
library(vegan)
```


## Sources

The file handles are set in config.R as they're used by both this script and data_cleaning.

```{r}
source("/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/from_Leo/Leonardos_analysis/bin/core_functions.R")
source("/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/from_Leo/Leonardos_analysis/bin/config.R")
```


## Metadata basics

First do the plots with kruskall wallis comparison between groups to see if there's an overall difference, then do the pairwise tests because KW says there is a difference.


```{r}
metadata <- read_metadata(metadata_handle)

number_per_country <- metadata %>% group_by(Country) %>% summarise(count = n())

number_per_country %>% kbl() %>% kable_styling()

print(sum(number_per_country$count))

baseline_chars <- get_baseline_characteristics(metadata)
baseline_chars %>% kbl(digits = c(NA, NA, 0, 0, 1, 1)) %>% kable_styling()

ggplot(metadata, aes(x = Country, y = Age, fill = Group)) + geom_boxplot() + stat_compare_means(method = 'kruskal.test', label = "p")
comparisons <- list(c("Acute_Typhi", "Carrier"), c("Acute_Typhi", "Control_HealthySerosurvey"), c("Carrier", "Control_HealthySerosurvey"))
# default stat method when doing pairwise tests in wilcoxon.
ggboxplot(metadata, facet.by = "Country", y = "Age", x = "Group", color = "Group") + stat_compare_means(comparisons = comparisons) + rremove("x.text") + rremove("xlab") + rremove("x.ticks") # +rotate_x_text(angle = 45)
```

## pairwise beta

```{r}
run_plot_beta <- function(output_folder, meta, vars_to_plot){
  pcoa.data.handle <- file.path(output_folder, '4_beta', "first_2d_coords.txt")
  pcoa.var.handle <- file.path(output_folder, '4_beta', "pcoa_var.txt")
  pcoa.data <- read_delim(pcoa.data.handle, delim = " ", escape_double = FALSE, trim_ws = TRUE)
  #pcoa.data <- pcoa.data %>% separate(col = Y, sep = '\t', into = c('x', 'y')) %>% rename(ID = X)
  pcoa.var <- read_delim(pcoa.var.handle, delim = " ", escape_double = FALSE, trim_ws = TRUE)
  #pcoa.data <- read_tsv(pcoa.data.handle)
  
  meta_for_beta <- meta %>% select(isolate, Country, Group, Sex, age_bracket, Antibiotics_taken_before_sampling_yes_no_assumptions, group_country, group_antibiotic)
  
  pcoa.data <- left_join(pcoa.data, meta_for_beta, by = c('Sample' = 'isolate'))

  # add some different plots to the below
  # or, change this function to take the variable to colour by
  plots <- plot_beta(pcoa.data, pcoa.var, vars_to_plot)
  return(plots)
}
```

### All three countries

Plots

```{r}
all_three_vars_to_plot <- c('Country', 'Group', 'Sex', 'age_bracket', 'group_country', 'group_antibiotic')
all_three_plots <- run_plot_beta(output_folder_all_three, metadata, all_three_vars_to_plot)

all_three_plots$country_plot
all_three_plots$group_plot
all_three_plots$sex_plot
all_three_plots$age_plot
all_three_plots$group_country_plot
all_three_plots$group_antibiotic_plot

```

PERMANOVA

```{r}
pn_all3_csgaa_res <- read_delim(file.path(output_folder_all_three, '4_beta', 'permanova.results.tsv'))
pn_all3_csgaa_res %>% kbl %>% kable_styling()
```


### Just Blantyre

Plots

```{r}
blantyre_vars_to_plot <- c('Group', 'Sex', 'age_bracket', 'group_antibiotic')
blantyre_plots <- run_plot_beta(output_folder_blantyre, metadata, all_three_vars_to_plot)
blantyre_plots$group_plot
blantyre_plots$sex_plot
blantyre_plots$age_plot
blantyre_plots$group_antibiotic_plot
```

PERMANOVA

```{r}
pn_blantyre_sgaa_res <- read_delim(file.path(output_folder_blantyre, '4_beta', 'permanova.results.tsv'))
pn_blantyre_sgaa_res %>% kbl %>% kable_styling()

```

### Just Dhaka

Plots

```{r}
dhaka_vars_to_plot <- c('Group', 'Sex', 'age_bracket', 'group_antibiotic')
dhaka_plots <- run_plot_beta(output_folder_dhaka, metadata, all_three_vars_to_plot)
dhaka_plots$group_plot
dhaka_plots$sex_plot
dhaka_plots$age_plot
dhaka_plots$group_antibiotic_plot
```

PERMANOVA

```{r}
pn_dhaka_sgaa_res <- read_delim(file.path(output_folder_dhaka, '4_beta', 'permanova.results.tsv'))
pn_dhaka_sgaa_res %>% kbl %>% kable_styling()
```


### Just Kathmandu

Plots

```{r}
kathmandu_vars_to_plot <- c('Group', 'Sex', 'age_bracket', 'group_antibiotic')
kathmandu_plots <- run_plot_beta(output_folder_kathmandu, metadata, all_three_vars_to_plot)
kathmandu_plots$group_plot
kathmandu_plots$sex_plot
kathmandu_plots$age_plot
kathmandu_plots$group_antibiotic_plot
```

PERMANOVA

```{r}
pn_kathmandu_sgaa_res <- read_delim(file.path(output_folder_kathmandu, '4_beta', 'permanova.results.tsv'))
pn_kathmandu_sgaa_res %>% kbl %>% kable_styling()
```

### Blantyre and Dhaka


Plots

```{r}
blantyre_dhaka_vars_to_plot <- c('Group', 'Sex', 'age_bracket', 'group_antibiotic')
blantyre_dhaka_plots <- run_plot_beta(output_folder_blantyre_dhaka, metadata, all_three_vars_to_plot)
blantyre_dhaka_plots$group_plot
blantyre_dhaka_plots$sex_plot
blantyre_dhaka_plots$age_plot
blantyre_dhaka_plots$group_antibiotic_plot
```

PERMANOVA

```{r}
pn_blantyre_dhaka_csgaa_res <- read_delim(file.path(output_folder_blantyre_dhaka, '4_beta', 'permanova.results.tsv'))
pn_blantyre_dhaka_csgaa_res %>% kbl %>% kable_styling()
```


## Alpha diversity

```{r}
meta_for_alpha <- metadata %>% select(isolate, Group, Sex, Country, Antibiotics_taken_before_sampling_yes_no_assumptions, age_bracket)

```


### all three

ANOVA results

```{r}
anova_all_three_csgaa_res <- read_delim(file.path(output_folder_all_three, '3_alpha', 'shannon.anova.results.tsv'), delim = '\t')
anova_all_three_csgaa_res %>% kbl %>% kable_styling()
```

Plots

```{r}
all_three_shannon_alpha <- read_delim(file.path(output_folder_all_three, '3_alpha', 'shannon.alpha_results.tsv'))
all_three_shannon_alpha <- left_join(all_three_shannon_alpha, meta_for_alpha, by = 'isolate', )

ggplot(all_three_shannon_alpha, aes(x=Country, y=alpha, fill = Group)) + 
  ggtitle("All three countries - country by group") + 
  labs(x="", y="Alpha diversity") +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) #+
  #geom_point(alpha = 0.3, position = "jitter")

ggplot(all_three_shannon_alpha, aes(x=Country, y=alpha, fill = Antibiotics_taken_before_sampling_yes_no_assumptions)) + 
  ggtitle("All three countries - country by group") + 
  labs(x="", y="Alpha diversity") +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

### blantyre

ANOVA

```{r}

anova_blantyre_sgaa_res <- read_delim(file.path(output_folder_blantyre, '3_alpha', 'shannon.anova.results.tsv'), delim = '\t')
anova_blantyre_sgaa_res %>% kbl %>% kable_styling()

```

Plots

- The p-value on the graph is a kruskal wallis test (which is just wilcoxon i think?)

```{r}
blantyre_shannon_alpha <- read_delim(file.path(output_folder_blantyre, '3_alpha', 'shannon.alpha_results.tsv'))
blantyre_shannon_alpha <- left_join(blantyre_shannon_alpha, meta_for_alpha, by = 'isolate')

my_comparisons <- list(c('No', 'Yes'), c('No', 'Yes'), c('No', 'Yes'))

ggplot(blantyre_shannon_alpha, aes(x=age_bracket, y=alpha, fill = Antibiotics_taken_before_sampling_yes_no_assumptions)) + 
  #ggtitle("All three countries - country by group") + 
  labs(x="", y="Alpha diversity") +
  geom_boxplot(outlier.shape = NA, alpha = 0.2) +
  #geom_point(aes(color=as.factor(Antibiotics_taken_before_sampling_yes_no_assumptions)), alpha = 0.3) +
  geom_point(alpha = 0.5, position=position_dodge(width=0.75),aes(group=Antibiotics_taken_before_sampling_yes_no_assumptions, color=as.factor(Antibiotics_taken_before_sampling_yes_no_assumptions))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  stat_compare_means(label.y = c(5.2, 5.5, 5.7), size = 4, label = "p.format")

```


### dhaka

```{r}

anova_dhaka_sgaa_res <- read_delim(file.path(output_folder_dhaka, '3_alpha', 'shannon.anova.results.tsv'), delim = '\t')
anova_dhaka_sgaa_res %>% kbl %>% kable_styling()

```

### kathmandu

```{r}

anova_kathmandu_sgaa_res <- read_delim(file.path(output_folder_kathmandu, '3_alpha', 'shannon.anova.results.tsv'), delim = '\t')
anova_kathmandu_sgaa_res %>% kbl %>% kable_styling()

```
