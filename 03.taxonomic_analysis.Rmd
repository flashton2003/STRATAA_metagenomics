---
title: "STRATAA Microbiome - taxonomic analysis"
author: "Philip Ashton"
date: "`r Sys.Date()`"
output: 
  html_document:
      toc: true
      toc_float: true
      theme: united
      number_sections: true
---

```{r setup, error=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

# STRATAA microbiome taxonomic analysis

## Sources

The file handles are set in config.R as they're used by both this script and data_cleaning. The imports are done in the core functions file.

```{r source, error=FALSE}
source("/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/from_Leo/Leonardos_analysis/bin/00.core_functions.R")
source("/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/from_Leo/Leonardos_analysis/bin/config.R")
```

## Read in metadata

```{r metadata_read_in, error=FALSE}
metadata <- read_metadata(metadata_handle)
# putting this here so that the output files of maaslin get named accroding to the variable names in the metadata file.
metadata <- metadata %>% mutate(Group = if_else(Group == 'Control_HealthySerosurvey', 'Household contact', Group)) %>% mutate(Group = if_else(Group == 'Acute_Typhi', 'Acute typhoid', Group)) %>% mutate(Group = if_else(Group == 'Carrier', 'High Vi-titre', Group))
```

## read in metaphlan data
```{r read_in_metaphlan, error=FALSE}
strataa_metaphlan_data <- read.csv(file = file.path(metaphlan_input_folder, '2023.05.11.all_strataa_metaphlan.csv'), header= TRUE, sep = ",", row.names = 1, stringsAsFactors = FALSE, check.names=FALSE)
strataa_metaphlan_data$lowest_taxonomic_level <- sapply(str_split(row.names(strataa_metaphlan_data), "\\|"), function(x) x[length(x)])
strataa_metaphlan_data_species <- strataa_metaphlan_data %>% filter(str_starts(lowest_taxonomic_level, 's__'))
# metadata <- read.csv(file = file.path(metaphlan_input_folder, '2023.05.11.strataa_metadata.metaphlan.csv'), header = TRUE, sep = ",", row.names = 1, stringsAsFactors = FALSE)
```

## Healthy vs Typhi

### alpha diversity
Alpha diversity - all countries, healthy and acute

```{r alpha_diversity_healthy_acute, error=FALSE}
all_countries_healthy_acute_alpha <- metaphlan_alpha(strataa_metaphlan_data_species, metadata, countries_of_interest = c('Bangladesh', 'Malawi', 'Nepal'), groups_of_interest = c('Acute typhoid', 'Household contact'), comparisons = list(c('Acute typhoid', 'Household contact')), participant_group_colours = participant_group_colours)
# all_countries_healthy_acute_alpha$alpha_by_country
all_countries_healthy_acute_alpha$alpha_anova_summary_with_var_names %>% dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% kbl() %>% kable_styling()
all_countries_healthy_acute_alpha$alpha_plot_group
# all_countries_healthy_acute_alpha$alpha_plot_antibiotics
```

### beta diversity 

Acute vs healthy.
```{r beta_diversity_healthy_acute, error=FALSE}
all_countries_beta_acute_healthy <- strataa_metaphlan_beta(strataa_metaphlan_data_species, metadata, c('Bangladesh', 'Malawi', 'Nepal'), c('Acute typhoid', 'Household contact'), participant_group_colours)
all_countries_beta_acute_healthy$pn_res %>% kbl %>% kable_styling()

bgd_beta_acute_healthy <- strataa_metaphlan_beta(strataa_metaphlan_data_species, metadata, c('Bangladesh'), c('Acute typhoid', 'Household contact'), participant_group_colours)
bgd_beta_acute_healthy$pn_res %>% kbl %>% kable_styling()

mal_beta_acute_healthy <- strataa_metaphlan_beta(strataa_metaphlan_data_species, metadata, c('Malawi'), c('Acute typhoid', 'Household contact'), participant_group_colours)
mal_beta_acute_healthy$pn_res %>% kbl %>% kable_styling()

nep_beta_acute_healthy <- strataa_metaphlan_beta(strataa_metaphlan_data_species, metadata, c('Nepal'), c('Acute typhoid', 'Household contact'), participant_group_colours)
nep_beta_acute_healthy$pn_res %>% kbl %>% kable_styling()

all_countries_beta_acute_healthy$pc12 + bgd_beta_acute_healthy$pc12 + mal_beta_acute_healthy$pc12 + nep_beta_acute_healthy$pc12 + plot_layout(guides = 'collect')
```

### maaslin2 taxonomy

Maaslin basics

```{r basics_for_maaslin_taxonomic, error=FALSE}
# the names here should be the full name from the metadata file, not the "presentation" name
# because this is used to read in the files, which are written using the full name.
groups_to_analyse <- c('Acute_Typhi', 'Control_HealthySerosurvey')
bang_variables_for_analysis <- c("Group", "Sex", "Age", "Antibiotics_taken_before_sampling_assumptions")
mwi_variables_for_analysis <- c("Group", "Sex", "Age", "Antibiotics_taken_before_sampling_assumptions", "sequencing_lane")
nep_variables_for_analysis <- c("Group", "Sex", "Age", "Antibiotics_taken_before_sampling_assumptions")
```

```{r read_in_maaslin_taxonomic, error=FALSE}
bangladesh_taxonomic_maaslin_acute_healthy <- read_in_maaslin('Bangladesh', groups_to_analyse, bang_variables_for_analysis, 'metaphlan')
malawi_taxonomic_maaslin_acute_healthy <- read_in_maaslin('Malawi', groups_to_analyse, mwi_variables_for_analysis, 'metaphlan')
nepal_taxonomic_maaslin_acute_healthy <- read_in_maaslin('Nepal', groups_to_analyse, nep_variables_for_analysis, 'metaphlan')
```

```{r filter_maaslin_taxonomic, error=FALSE}
bangladesh_taxonomic_maaslin_acute_healthy_filtered <- filter_taxonomic_maaslin(bangladesh_taxonomic_maaslin_acute_healthy)
malawi_taxonomic_maaslin_acute_healthy_filtered <- filter_taxonomic_maaslin(malawi_taxonomic_maaslin_acute_healthy)
nepal_taxonomic_maaslin_acute_healthy_filtered <- filter_taxonomic_maaslin(nepal_taxonomic_maaslin_acute_healthy)
```

```{r basic_stats_maaslin_taxonomic, error=FALSE}
bangladesh_maaslin_acute_healthy_stats <- basic_maaslin_stats(bangladesh_taxonomic_maaslin_acute_healthy_filtered, 'Bangladesh', bang_variables_for_analysis, groups_to_analyse)
malawi_maaslin_acute_healthy_stats <- basic_maaslin_stats(malawi_taxonomic_maaslin_acute_healthy_filtered, 'Malawi', mwi_variables_for_analysis, groups_to_analyse)
nepal_maaslin_acute_healthy_stats <- basic_maaslin_stats(nepal_taxonomic_maaslin_acute_healthy_filtered, 'Nepal', nep_variables_for_analysis, groups_to_analyse)
```

There were `r nrow(malawi_maaslin_stats$maaslin_results_sig)` species significantly (q-val < 0.05) associated with health/disease in Malawi, `r nrow(bangladesh_maaslin_stats$maaslin_results_species_group_sig)` in Bangladesh, and `r nrow(nepal_maaslin_stats$maaslin_results_species_group_sig)` in Nepal.

Combine the taxonomic maaslins, and print out the species that are sig in both and share directions.

Because sequencing run and participant type are totally confounded for Bangladesh, need to exclude sequencing run from the final model for Bangladesh (otherwise, wipes out the signals).

associated at both sites
```{r combine_maaslins_taxonomic, error=FALSE}

bang_mal <- list(bangladesh_taxonomic_maaslin_acute_healthy_filtered, malawi_taxonomic_maaslin_acute_healthy_filtered)
combined_results <- run_inner_join_maaslins(bang_mal, c('_bang', '_mal'), mwi_variables_for_analysis, groups_to_analyse, 'metaphlan', maaslin_taxonomic_output_root_folder)
combined_filtered_maaslins <- filter_combined_maaslins(combined_results)


combined_filtered_maaslins$positive_coef %>% filter(grepl('^s', lowest_taxonomic_level)) %>% 
  select(!c(metadata, value, N_bang, N.not.0_bang, pval_bang, N_mal, N.not.0_mal, pval_mal)) %>% 
  rename(Species = lowest_taxonomic_level, `Coefficient Bangladesh` = coef_bang, `Standard Error Bangladesh` = stderr_bang, `Q-value Bangladesh` = qval_bang, `Coefficient Malawi` = coef_mal, `Standard Error Malawi` = stderr_mal, `Q-value Malawi` = qval_mal) %>% 
  dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% 
  kbl() %>% kable_styling()

combined_filtered_maaslins$negative_coef %>% filter(grepl('^s', lowest_taxonomic_level)) %>% 
  select(!c(metadata, value, N_bang, N.not.0_bang, pval_bang, N_mal, N.not.0_mal, pval_mal)) %>% 
  rename(Species = lowest_taxonomic_level, `Coefficient Bangladesh` = coef_bang, `Standard Error Bangladesh` = stderr_bang, `Q-value Bangladesh` = qval_bang, `Coefficient Malawi` = coef_mal, `Standard Error Malawi` = stderr_mal, `Q-value Malawi` = qval_mal) %>% 
  dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% 
  kbl() %>% kable_styling()

# todo - refactoring the run_combine_maaslins means that we dont get the species that are only associated at one site. need to fix that.

# nrow(combined_results$mwi_maaslin_only)
# nrow(combined_results$bang_maaslin_only)

mal_bang_maaslins <- rbind(combined_filtered_maaslins$positive_coef, combined_filtered_maaslins$negative_coef)
# View(combined_results$positive_coef )

# do an anti-join to get the species that are only associated at one site
bang_only <- anti_join(bangladesh_taxonomic_maaslin_filtered, mal_bang_maaslins, by = c('feature', 'metadata', 'value')) %>% filter(qval < 0.05)
mal_only <- anti_join(malawi_taxonomic_maaslin_filtered, mal_bang_maaslins, by = c('feature', 'metadata', 'value')) %>% filter(qval < 0.05)

bang_only %>% 
  rename(Species = lowest_taxonomic_level, `Coefficient` = coef, `Standard Error` = stderr, `Q-value` = qval) %>% 
  dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% 
  kbl() %>% kable_styling()

mal_only %>% 
  rename(Species = lowest_taxonomic_level, `Coefficient` = coef, `Standard Error` = stderr, `Q-value` = qval) %>% 
  dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% 
  kbl() %>% kable_styling()

```

There were `r nrow(mal_only)` species significantly (q-val < 0.05) associated with health/disease in Malawi only and `r nrow(bang_only)` in Bangladesh only.

The ones associated at only one site are written out to a file, you can look at them manually there.

### Forest plot

Setting up the forest plots. Need to combine all three maaslin outputs, and then add in the patch data.

```{r combine_maaslins_for_strataa_and_patch, error=FALSE}
# combine the maaslines for bgd and mal, and then add in the nepal ones.
combined_maaslins <- inner_join_maaslins(bangladesh_taxonomic_maaslin, malawi_taxonomic_maaslin, '_bang', '_mal', 'metaphlan')
combined_maaslins <- inner_join_maaslins(combined_maaslins, nepal_taxonomic_maaslin, 'not', 'used', 'metaphlan')
# for the nepal columns, give them a "_nep" suffix
combined_maaslins <- combined_maaslins %>%
  rename_with(~ paste0(.x, '_nep'), c("coef", "stderr", "N", "N.not.0", "pval", "qval"))

# get the patch data
patch_taxonomic_maaslin <- read_tsv(file.path(patch_maaslin_taxonomic_output_root_folder, 'baseline_typhi_species', 'all_results.tsv'))
patch_taxonomic_maaslin$lowest_taxonomic_level <- sapply(str_split(patch_taxonomic_maaslin$feature, "\\."), function(x) x[length(x)])
patch_taxonomic_maaslin <- patch_taxonomic_maaslin %>% relocate(lowest_taxonomic_level, .after = feature)
patch_taxonomic_maaslin <- patch_taxonomic_maaslin %>%
  rename_with(~ paste0(.x, '_patch'), c("coef", "stderr", "N", "N.not.0", "pval", "qval"))

# in patch_taxonomic_maaslin, change all Diagnosis in metadata column to Group, and all 'no_disease' in value column to 'ControlHealthySerosurvey'
# this is to match the other maaslin outputs
patch_taxonomic_maaslin <- patch_taxonomic_maaslin %>% filter(metadata == 'Diagnosis')
# in patch_taxonomic_maaslin, change all Diagnosis in metadata column to Group, and all 'no_disease' in value column to 'ControlHealthySerosurvey'
patch_taxonomic_maaslin$metadata <- ifelse(patch_taxonomic_maaslin$metadata == 'Diagnosis', 'Group', patch_taxonomic_maaslin$metadata)
patch_taxonomic_maaslin$value <- ifelse(patch_taxonomic_maaslin$value == 'no_disease', 'Control_HealthySerosurvey', patch_taxonomic_maaslin$value)

# join the patch data to the combined maaslin data
combined_maaslins <- combined_maaslins %>% left_join(patch_taxonomic_maaslin, by = c("feature", 'metadata', 'value', 'lowest_taxonomic_level'))

```

for the forest plot, i also want to include the per-cohort abundance medians for the species of interest.

```{r species_of_interest_prevalence, error=FALSE}

groups_to_analyse <- c('Acute typhoid', 'Household contact')
prevalence <- get_prevalence(strataa_metaphlan_data_species, groups_to_analyse)

```
do the forest plot

```{r per_species_data_for_forest_plot, error=FALSE}
# prevalence is the relative abundance data, the species of interest are the ones that are significantly associated with health/disease in two countries, and combined_maaslins is the maaslin output with the associations
run_forest_plot(prevalence, c('s__Prevotella_copri_clade_A', 's__Clostridium_SGB6179', 's__GGB4266_SGB5809', 's__Haemophilus_parainfluenzae'), combined_maaslins)

```


### plots of species of interest

```{r plot_species_of_interest_taxonomic, error=FALSE}

strataa_metaphlan_data_longer <- strataa_metaphlan_data %>% mutate(feature = rownames(strataa_metaphlan_data)) %>% pivot_longer(!c(feature, lowest_taxonomic_level), names_to = "SampleID", values_to = "prevalence")
# View(head(strataa_metaphlan_data_longer))
strataa_metaphlan_data_longer_meta <- strataa_metaphlan_data_longer %>% left_join(metadata, by = c("SampleID" = "SampleID"))

pc <- run_plot_species_of_interest(strataa_metaphlan_data_longer_meta, 's__Prevotella_copri_clade_A', participant_group_colours)
cs <- run_plot_species_of_interest(strataa_metaphlan_data_longer_meta, 's__Clostridium_SGB6179', participant_group_colours)
SGB5809 <-run_plot_species_of_interest(strataa_metaphlan_data_longer_meta, 's__GGB4266_SGB5809', participant_group_colours)
hp <- run_plot_species_of_interest(strataa_metaphlan_data_longer_meta, 's__Haemophilus_parainfluenzae', participant_group_colours)
# rt <- run_plot_species_of_interest(strataa_metaphlan_data_longer_meta, 's__Romboutsia_timonensis', participant_group_colours)
# lb <- run_plot_species_of_interest(strataa_metaphlan_data_longer_meta, 's__Lachnospiraceae_bacterium', participant_group_colours)

# pc
  # pc + cs + SGB5809 + hp + rt + lb

```



## healthy vs carrier (parts include all participant groups)

We're not including the bangladesh samples in this analysis, because the bangladesh carriers were processed differently (extracted without being frozen).

### phylum plots

```{r phylum_plots_carrier_healthy, error=FALSE}

# metadata_for_phyla_plots <- metadata %>% dplyr::select(SampleID, Group, Country)
phyla_clean_metadata <- prep_data_to_plot_phyla(strataa_metaphlan_data, metadata)
order_of_groups <- c("High Vi-titre", "Household contact")
# bangladesh_phyla_plot <- plot_per_country_abundance(phyla_clean_metadata = phyla_clean_metadata, country = "Bangladesh", group_order = order_of_groups)
# bangladesh_phyla_plot
malawi_phyla_plot <- plot_per_country_abundance(phyla_clean_metadata = phyla_clean_metadata, country = "Malawi", group_order = order_of_groups)
nepal_phyla_plot <- plot_per_country_abundance(phyla_clean_metadata = phyla_clean_metadata, country = "Nepal", group_order = order_of_groups)

# bangladesh_phyla_plot / 
malawi_phyla_plot / nepal_phyla_plot + plot_layout(guides = 'collect')
```

### alpha diversity

Alpha diversity - Malawi and Nepal, healthy and carrier.

```{r alpha_diversity_healthy_carrier, error=FALSE}
# malawi_nepal_healthy_carrier_alpha <- metaphlan_alpha(strataa_metaphlan_data_species, metadata, countries_of_interest = c('Malawi', 'Nepal'), groups_of_interest = c('High Vi-titre', 'Household contact', 'Acute typhoid'), comparisons = list(c('High Vi-titre', 'Household contact'), c('High Vi-titre', 'Acute typhoid'), c('Household contact', 'Acute typhoid')), participant_group_colours)
# malawi_nepal_healthy_carrier_alpha$alpha_by_country
# malawi_nepal_healthy_carrier_alpha$alpha_anova_summary_with_var_names %>% dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% kbl() %>% kable_styling()
# malawi_nepal_healthy_carrier_alpha$alpha_plot_group
```

Alpha diversity - Malawi and Nepal, healthy, typhoid, and carrier.

```{r alpha_diversity_healthy_carrier_typhoid, error=FALSE}
malawi_nepal_healthy_carrier_alpha <- metaphlan_alpha(strataa_metaphlan_data_species, metadata, countries_of_interest = c('Malawi', 'Nepal'), groups_of_interest = c('High Vi-titre', 'Household contact', 'Acute typhoid'), comparisons = list(c('High Vi-titre', 'Household contact')), participant_group_colours)
malawi_nepal_healthy_carrier_alpha$alpha_by_country
malawi_nepal_healthy_carrier_alpha$alpha_anova_summary_with_var_names %>% dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% kbl() %>% kable_styling()
malawi_nepal_healthy_carrier_alpha$alpha_plot_group
```

### beta diversity

High Vi-titre vs healthy.
```{r beta_diversity_healthy_carrier, error=FALSE}

all_countries_beta_carrier_healthy <- strataa_metaphlan_beta(strataa_metaphlan_data_species, metadata, c('Malawi', 'Nepal'), c('High Vi-titre', 'Household contact', 'Acute typhoid'), participant_group_colours)
# all_countries_beta_carrier_healthy$pn_res %>% kbl %>% kable_styling()


mal_beta_carrier_healthy_typhoid <- strataa_metaphlan_beta(strataa_metaphlan_data_species, metadata, c('Malawi'), c('High Vi-titre', 'Household contact', 'Acute typhoid'), participant_group_colours)
mal_beta_carrier_healthy_typhoid$pn_res %>% kbl %>% kable_styling()

nep_beta_carrier_healthy_typhoid <- strataa_metaphlan_beta(strataa_metaphlan_data_species, metadata, c('Nepal'), c('High Vi-titre', 'Household contact', 'Acute typhoid'), participant_group_colours)
nep_beta_carrier_healthy_typhoid$pn_res %>% kbl %>% kable_styling()

mal_beta_carrier_healthy_typhoid$pc12 + nep_beta_carrier_healthy$pc12 + plot_layout(guides = 'collect')
```

### maaslin taxonomic groups

```{r basics_for_maaslin_taxonomic_carrier_healthy, error=FALSE}
# groups_to_analyse <- c('Acute_typhi', 'Control_HealthySerosurvey')
# use the original metadata variable names, not the presentation names because that's what the maaslin2 results are saved as.
groups_to_analyse <- c('Carrier', 'Control_HealthySerosurvey')
# bang_variables_for_analysis <- c("Group", "Sex", "Age")
mwi_variables_for_analysis <- c("Group", "Sex", "Age", "sequencing_lane")
nep_variables_for_analysis <- c("Group", "Sex", "Age")
```

```{r read_in_maaslin_taxonomic_carrier_healthy, error=FALSE}
# bangladesh_taxonomic_maaslin <- read_in_maaslin('Bangladesh', groups_to_analyse, bang_variables_for_analysis, 'metaphlan')
malawi_taxonomic_maaslin <- read_in_maaslin('Malawi', groups_to_analyse, mwi_variables_for_analysis, 'metaphlan')
nepal_taxonomic_maaslin <- read_in_maaslin('Nepal', groups_to_analyse, nep_variables_for_analysis, 'metaphlan')
```

```{r filter_maaslin_taxonomic_carrier_healthy, error=FALSE}
# bangladesh_taxonomic_maaslin_filtered <- filter_taxonomic_maaslin(bangladesh_taxonomic_maaslin)
malawi_taxonomic_maaslin_filtered <- filter_taxonomic_maaslin(malawi_taxonomic_maaslin)
nepal_taxonomic_maaslin_filtered <- filter_taxonomic_maaslin(nepal_taxonomic_maaslin)
```

```{r basic_stats_maaslin_taxonomic_carrier_healthy, error=FALSE}
# bangladesh_maaslin_stats <- basic_maaslin_stats(bangladesh_taxonomic_maaslin_filtered, 'Bangladesh', bang_variables_for_analysis, groups_to_analyse)
malawi_taxonomic_maaslin_health_carrier_filtered <- basic_maaslin_stats(malawi_taxonomic_maaslin_filtered, 'Malawi', mwi_variables_for_analysis, groups_to_analyse)
nepal_taxonomic_maaslin_health_carrier_filtered <- basic_maaslin_stats(nepal_taxonomic_maaslin_filtered, 'Nepal', nep_variables_for_analysis, groups_to_analyse)
nrow(malawi_taxonomic_maaslin_health_carrier_filtered$maaslin_results_sig)
nrow(nepal_taxonomic_maaslin_health_carrier_filtered$maaslin_results_sig)
```

There are no species significantly associated with carrier status in both Mal and Nep, so not doing the combine.

```{r}
malawi_taxonomic_maaslin_health_carrier_filtered$maaslin_results_sig %>% kbl %>% kable_styling()
nepal_taxonomic_maaslin_health_carrier_filtered$maaslin_results_sig %>% kbl %>% kable_styling()
```

Combine the nepal_taxonomic_maaslin_health_carrier_filtered$maaslin_results_sig and 