---
title: "PATCH Microbiome"
author: "Philip Ashton"
date: "`r Sys.Date()`"
output: 
  html_document:
      toc: true
      toc_float: true
      theme: united
      number_sections: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)

```

# PATCH microbiome analysis

## Imports
```{r}
library(rbiom)
library(kableExtra)
library(ggplot2)
library(ggpubr)
library(ggforce)
library(patchwork)
library(vegan)
library(dplyr)
library(forcats)
library(Maaslin2)


```


## Sources

The file handles are set in config.R as they're used by both this script and data_cleaning.

```{r source}
source("/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/from_Leo/Leonardos_analysis/bin/core_functions.R")
source("/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/from_Leo/Leonardos_analysis/bin/config.R")
```


## Metadata basics

First do the plots with kruskall wallis comparison between groups to see if there's an overall difference, then do the pairwise tests because KW says there is a difference.


```{r metadata_read_in}

patch_metadata <- read.csv(file = patch_metadata_handle, header = TRUE, sep = ",", row.names = 1, stringsAsFactors = FALSE)
patch_metadata$SampleID <- row.names(patch_metadata)
metadata_subset <- patch_metadata %>% 
  select(Run, Patient, Gender, age_at_challenge, Group, Species, Challenge, Visit, Day, day_group, Diagnosis, Dose, SampleID, pre_post_antibiotics) %>% 
  mutate(rechallenge = ifelse(grepl('-', Group), 'rechallenge', 'first_challenge')) %>% 
  mutate(Dose = as.numeric(Dose))

baseline_metadata <- metadata_subset %>% filter(day_group == 'baseline')
```

## read in metaphlan data
```{r read_in_metaphlan}
metaphlan_data <- read.csv(file = patch_metaphlan_handle, header= TRUE, sep = ",", row.names = 1, stringsAsFactors = FALSE, check.names=FALSE)
metaphlan_data$lowest_taxonomic_level <- sapply(str_split(row.names(metaphlan_data), "\\|"), function(x) x[length(x)])
metaphlan_data_species <- metaphlan_data %>% filter(str_starts(lowest_taxonomic_level, 's__'))


```

##Â Alpha diversity

```{r alpha_diversity}
metaphlan_data_species_for_alpha <- metaphlan_data_species %>% select(!lowest_taxonomic_level)
alpha <- rbiom::alpha.div(as.matrix(metaphlan_data_species_for_alpha))
alpha_meta <- left_join(alpha, metadata_subset, by = c('Sample' = 'SampleID')) %>% filter(day_group == 'baseline')
alpha_anova <- aov(Shannon ~ Gender * rechallenge * Diagnosis, data = alpha_meta)
alpha_anova_summary <- summary(alpha_anova)  
alpha_anova_summary_with_var_names <- cbind(rownames(alpha_anova_summary[[1]]), data.frame(alpha_anova_summary[[1]], row.names = NULL))
alpha_anova_summary_with_var_names <- alpha_anova_summary_with_var_names %>% mutate(is_it_significant = ifelse(`Pr..F.` < 0.01, 'significant', 'not_significant')) %>% arrange(desc(is_it_significant), `Pr..F.`)
alpha_anova_summary_with_var_names %>% dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% kbl() %>% kable_styling()
```

## Beta diversity

### all samples, by group
```{r beta_diversity}


# metadata_coi <- metadata %>% filter(Country %in% countries_of_interest) %>% filter(Group %in% groups_of_interest)

baseline_ids <- baseline_metadata %>% pull(SampleID)
metaphlan_data_baseline <- metaphlan_data %>% select(all_of(baseline_ids))
groups_of_interest <- c('patch_baseline')
rbd_output <- run_beta_diversity(metaphlan_data_baseline, baseline_metadata, groups_of_interest)
rbd_output$pn_res
# View(pcoa_df)
# title <- paste(countries_of_interest, collapse = "_")
pc12_group <- ggplot(rbd_output$pcoa_df, aes(x = PC1, y = PC2, colour = Group)) + 
  geom_point() +
  ggtitle('Group') +
  coord_fixed() + 
  stat_ellipse()


pc12_diagnosis <- ggplot(rbd_output$pcoa_df, aes(x = PC1, y = PC2, colour = Diagnosis)) + 
  geom_point() +
  ggtitle('Diagnosis') +
  coord_fixed() + 
  stat_ellipse()

pc12_rechallenge <- ggplot(rbd_output$pcoa_df, aes(x = PC1, y = PC2, colour = rechallenge)) + 
  geom_point() +
  ggtitle('rechallenge') +
  coord_fixed() + 
  stat_ellipse()

pc12_group
pc12_diagnosis
pc12_rechallenge
# p <- list(pc12 = pc12, pc34 = pc34, pn_res = pn_res)
# return(p)
```

## check blocking

```{r check_blocking}
# how are the diagnoses spread across different runs?
baseline_metadata %>% group_by(Run, Diagnosis) %>% summarise(n = n()) %>% kbl() %>% kable_styling()
```

## maaslin2 metaphlan

```{r }
baseline_metadata_typhi <- baseline_metadata %>% filter(Group == 'Typhi')
baseline_metadata_no_bicarb <- baseline_metadata %>% filter(Group != 'Bicarbonate')
baseline_metadata_no_bicarb_first_challenge <- baseline_metadata %>% filter(Group != 'Bicarbonate') %>% filter(Challenge == '1st')
baseline_metadata_paratyphi <- baseline_metadata %>% filter(Group == 'Paratyphi')
baseline_metadata_typhi_paratyphi <- baseline_metadata %>% filter(Group == 'Typhi' | Group == 'Paratyphi') 


metaphlan_data_species_only <- metaphlan_data %>% filter(str_starts(lowest_taxonomic_level, 's__')) %>% select(!lowest_taxonomic_level)
colnames(metaphlan_data_species_only) <- colnames(metaphlan_data_species_only) %>% str_replace_all('#', '_')

```

```{r maaslin2_baseline}
#bgd_acute_healthy_output_dir <- file.path(maaslin_taxonomic_output_root_folder, paste())
# variables_for_analysis <- c("Gender", "Group", "Diagnosis", "Run")
variables_for_analysis <- c("Gender", "Diagnosis", "Run", 'age_at_challenge')

Maaslin2(input_data = metaphlan_data_species_only, input_metadata = baseline_metadata_typhi, analysis_method = "LM", min_prevalence = 0,
           normalization  = 'NONE',
           transform = 'LOG',
           output         = file.path(patch_maaslin_taxonomic_output_root_folder, 'baseline_typhi_species'), 
           fixed_effects  = variables_for_analysis,
           reference = c('Run,run_1'))

Maaslin2(input_data = metaphlan_data_species_only, input_metadata = baseline_metadata_paratyphi, analysis_method = "LM", min_prevalence = 0,
           normalization  = 'NONE',
           transform = 'LOG',
           output         = file.path(patch_maaslin_taxonomic_output_root_folder, 'baseline_metadata_paratyphi'), 
           fixed_effects  = variables_for_analysis,
           reference = c('Run,run_1'))


Maaslin2(input_data = metaphlan_data_species_only, input_metadata = baseline_metadata_typhi_paratyphi, analysis_method = "LM", min_prevalence = 0,
           normalization  = 'NONE',
           transform = 'LOG',
           output         = file.path(patch_maaslin_taxonomic_output_root_folder, 'baseline_metadata_typhi_paratyphi'), 
           fixed_effects  = variables_for_analysis,
           reference = c('Run,run_1'))


```

Including multiple samples per participant.

```{r maaslin2_baseline_multiple_samples}

metadata_pre_antibiotics <- metadata_subset %>% filter(Group != 'Bicarbonate', pre_post_antibiotics == 'pre') %>% mutate(Patient = as.character(Patient)) 

#bgd_acute_healthy_output_dir <- file.path(maaslin_taxonomic_output_root_folder, paste())
# variables_for_analysis <- c("Gender", "Group", "Diagnosis", "Run")
variables_for_analysis <- c("Diagnosis")
# run_maaslin(metaphlan_data_baseline, baseline_metadata, maaslin_taxonomic_output_root_folder, 'Bangladesh', groups_to_analyse, variables_for_analysis, 'NONE', 'LOG', NA, 'metaphlan')

metaphlan_data_no_ltl <- metaphlan_data %>% select(!lowest_taxonomic_level)

# metaphlan_data_phylum <- metaphlan_data %>% mutate(clade_name = row.names(metaphlan_data)) %>% filter(grepl('p__', clade_name)) %>% filter(!grepl('c__', clade_name))

Maaslin2(input_data = metaphlan_data_no_ltl, input_metadata = metadata_pre_antibiotics, analysis_method = "LM", min_prevalence = 0,
           normalization  = 'NONE',
           transform = 'LOG',
           output         = file.path(patch_maaslin_taxonomic_output_root_folder, 'all_pre_abr_samples'), 
           fixed_effects  = variables_for_analysis,
           random_effects = 'Patient')

# reference = 'Patient,8005'
```

## functional analysis

```{r}

patch_bigmap_handle <- "/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/patch_data/big-map/2023.05.11/all_RPKMs.transpose.csv"
patch_bigmap <- read.csv(file = patch_bigmap_handle, header= TRUE, sep = ",", row.names = 1, stringsAsFactors = FALSE, check.names=FALSE)
rownames(patch_bigmap) <- rownames(patch_bigmap) %>% str_replace_all('-', '_') %>% str_replace_all('#', '_')

# variables_for_analysis <- c("Gender", "Group", "Diagnosis", "Run")
variables_for_analysis <- c("Gender", "Diagnosis", "Run", 'age_at_challenge')

Maaslin2(input_data = patch_bigmap, input_metadata = baseline_metadata_typhi, analysis_method = "LM", min_prevalence = 0,
           normalization  = 'NONE',
           transform = 'LOG',
           output         = file.path('/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/patch_data/big-map/2023.05.11', 'baseline_just_typhi'), 
           fixed_effects  = variables_for_analysis,
           reference = c('Run,run_1'))

Maaslin2(input_data = patch_bigmap, input_metadata = baseline_metadata_paratyphi, analysis_method = "LM", min_prevalence = 0,
           normalization  = 'NONE',
           transform = 'LOG',
           output         = file.path('/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/patch_data/big-map/2023.05.11', 'baseline_metadata_paratyphi'), 
           fixed_effects  = variables_for_analysis,
           reference = c('Run,run_1'))

Maaslin2(input_data = patch_bigmap, input_metadata = baseline_metadata_typhi_paratyphi, analysis_method = "LM", min_prevalence = 0,
           normalization  = 'NONE',
           transform = 'LOG',
           output         = file.path('/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/patch_data/big-map/2023.05.11', 'baseline_metadata_typhi_paratyphi'), 
           fixed_effects  = variables_for_analysis,
           reference = c('Run,run_1'))
           

variables_for_analysis <- c("Gender", "Group", "Diagnosis", "Run")

           

Maaslin2(input_data = patch_bigmap, input_metadata = baseline_metadata_no_bicarb, analysis_method = "LM", min_prevalence = 0,
           normalization  = 'NONE',
           transform = 'LOG',
           output         = file.path('/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/patch_data/big-map/2023.05.11', 'baseline_metadata_no_bicarb'), 
           fixed_effects  = variables_for_analysis,
           reference = c('Run,run_1'))


Maaslin2(input_data = patch_bigmap, input_metadata = baseline_metadata_no_bicarb_first_challenge, analysis_method = "LM", min_prevalence = 0,
           normalization  = 'NONE',
           transform = 'LOG',
           output         = file.path('/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/patch_data/big-map/2023.05.11', 'baseline_metadata_no_bicarb_first_challenge'), 
           fixed_effects  = variables_for_analysis,
           reference = c('Run,run_1'))




Maaslin2(input_data = patch_bigmap, input_metadata = metadata_pre_antibiotics, analysis_method = "LM", min_prevalence = 0,
           normalization  = 'NONE',
           transform = 'LOG',
           output         = file.path('/Users/flashton/Dropbox/GordonGroup/STRATAA_Microbiome/patch_data/big-map/2023.05.11', 'all_pre_abr_samples'), 
           fixed_effects  = variables_for_analysis,
           random_effects =  'Patient')

```